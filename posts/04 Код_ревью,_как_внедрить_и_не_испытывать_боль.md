---
title: Код ревью, как внедрить и не испытывать боль
description: Статья о плюсах внедрения код-ревью на проекте и советы как его лучше реализовать.
date: 2021-08-18
tags:
- Тех
- Процесс
layout: layouts/post.njk
permalink: "/code-review-without-pain/"
image: https://sun9-43.userapi.com/impg/a13St1Phhsc-Gak52w_8nmUH5nAJcyAiaZ5OTQ/hX97JVazcLw.jpg?size=640x360&quality=96&sign=b2646a6194c54f1bf3a88ebf32ec63e8&type=album
---
## Зачем?

Если вы работаете в продуктовой компании, то жизненный цикл почти каждого продукта будет соответствовать [принципу Парето](https://ru.wikipedia.org/wiki/%D0%97%D0%B0%D0%BA%D0%BE%D0%BD_%D0%9F%D0%B0%D1%80%D0%B5%D1%82%D0%BE):

- 20% времени мы пишем новый код.
- 80% времени поддерживаем старый. Поддержка в себя включает фиксы багов, обновление кодовой базы (переезд на новые библиотеки например).

Во время поддержки мы хотим чтобы все разработчики как можно быстрее вникали в то, что написано. Для этого есть много способов, все они прекрасны и хорошо работают вместе.

Способы иметь хорошо поддерживаемый код:

- Покрытие тестами
- Ведение документации
- Код ревью

Все эти способы нужно уметь готовить. Есть тесты, которые только мешают, бесполезная документация и бессмысленный код ревью.

## Что же такое код ревью?

Основные понятия:
[Код ревью (code review)](https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%BE%D1%81%D0%BC%D0%BE%D1%82%D1%80_%D0%BA%D0%BE%D0%B4%D0%B0) - это часть процесса разработки продукта. В нем есть следующие участники:

- Автор - разработчик, который написал код. При этом любого объема, содержания и качества. Это может быть багфикс, фича
- Ревьюер - человек, который проверяет написанное, пишет замечания и возвращает код на доработку.

Что нам даёт код ревью:
➕ Проверку кода по многим критериям.
Автор не всегда видит **неочевидные места** в его коде (по разным причинам).
В результате написания и переписывания может быть потеряна **композиция**.
Автор, находясь в контексте задачи может недостаточно оставить **комментариев**.
Эти и многие другие проблемы может решить код ревью.

➕ Шаринг знаний о проекте.
Не только автор знает, что там пишется в другом проекте или части проекта, а все.

➕ Шаринг знаний о технологиях.
Вы можете заметить, что кто-то напилил своих костылей, а похожая проблема в проекте уже решалась. В таком случае ревьюер может подсказать что уже использовалось и избежать ненужного кода

➕ Сотрудники быстрее онбордятся.
Новые сотрудники, проводя код ревью, быстрее узнают и понимают традиции команды, а проходя его, имеют возможность исправить ошибки, узнать больше о продукте и меньше испытывать стресс.

Способов поддерживать код «качественным» есть много, но все их нужно правильно готовить. Нужно уметь писать тесты, нужно уметь писать документацию и нужно правильно организовать код ревью.

## Советы по организации процесса

❌ Ревьюить только джунов и новых коллег
✅ Проводить ревью для всех и всеми

В коде лидов тоже могут быть ошибки. Усталость, взгляд замылился, бабушка заболела, задачу неправильно понял - причин совершить ошибку может быть много. Коллеги со свежим взглядом помогут вовремя ошибку исправить.

Джуниор разработчики могут подсмотреть какие-то практики, методы, способы из кода сеньора. Вместо того, чтобы собирать их в переговорках и обучать - давайте читать новый код и задавать вопросы. Это уменьшит стоимость обучения и уровень стресса.

Если ревью проходят не все, то в вашей команде это будет восприниматься как источник недоверия и неравенства. Такую атмосферу следует избегать.

❌ Обсуждать на код ревью стиль
✅ Настроить у себя на проекте инструменты, которые автоматически будут исправлять стиль перед коммитом

В JS это eslint и prettier. Не тратьте время своё и коллег на споры о вкусах. Договоритесь заранее и пропишите правила. В случае разногласий голосуйте.

![](https://paper-attachments.dropbox.com/s_2F609ACD82D75F4A8DC0E50DFFEE216D00CD5915FEFA922E5E1FCCFDA5A0BE1A_1629225760479_+.jpeg)


❌ Ревьюер запускает руками билд или проверяет код на баги.
✅ Автор сам несет ответственность за поставленный код.

Проверять код в IDE и запускать код ревьюером - это огромная трата времени. Хорошо налаженный процесс выглядит так:

- Автор тщательно проверил свой код на работоспособность и залил в удаленный git репозиторий
- На сервере CI/CD проверяет тесты, сборку, работоспособность в целом.
- Проверка со стороны ревьюера.

И после исправления замечаний - всё, код отправляется на следующий этап. Если в коде есть ошибки они будут обнаружены отделом тестирования, либо попадут на прод.

Задача ревью не проверить всё на 100% - у вас это все равно не получится. Задача - иметь поддерживаемый, понятный и максимально “чистый” код.

❌ Ревьюер не читает код
✅ Обращать внимание на композицию, магические переменные, оптимизацию (там где это имеет смысл)

Ваша задача, как ревьюера, получить такой код, который в случае болезни разработчика вы завтра будете поддерживать и не потонете. Задача автора - писать код, который как будто будет поддерживать маньяк, который знает где живет автор.

![](https://paper-attachments.dropbox.com/s_2F609ACD82D75F4A8DC0E50DFFEE216D00CD5915FEFA922E5E1FCCFDA5A0BE1A_1629225778862_4b6799e20a115d32aa3ae2439679c79d.png)


❌ Агрессия, негатив, «токсичное» поведение в комментах
✅ Старайтесь отмечать не только негативные стороны, но и хвалить за позитивные.

Разработчики к своему коду всегда относятся довольно щепетильно. Не зря профессия считается творческой. Поэтому относится к проблемам на код ревью стоит так, как будто вам прислали оценить произведение собственного творчества - стих, картину, книги.

Агрессия, негатив и токсичное поведение в принципе стоит избегать во всех областях жизни. Грубое поведение во время код ревью может привести к:

- Конфликтам
- Стрессу и страху совершить ошибку
- Падению мотивации

Примеры плохих комментов:

> «это плохой код», «перепиши»

Примеры хороших комментов:

> «Давай попробуем сделать …» «Может попробуем вынести…»

То же самое касается и ответов на комменты автором. Если автор не согласен, то необходимо объяснять с помощью аргументов, а не фраз в духе "я так делать не буду". Если не получается текстом, иногда проще подойти или сделать короткий созвон, чтобы понять друг друга.

![](https://paper-attachments.dropbox.com/s_2F609ACD82D75F4A8DC0E50DFFEE216D00CD5915FEFA922E5E1FCCFDA5A0BE1A_1629225808297_-----5188107.jpeg)


❌ Все комментарии обязательны к исправлению
✅ Помечать необязательные комментарии

В замечаниях могут быть необязательные правки - например вкусовщина, или замечания, требующие большую переработку кода. Такие комментарии обязательно помечайте. Если автор не готов их пофиксить сразу, то:

- Когда правка относится к вкусовщине - забить
- Когда правка большая - завести под нее отдельную таску.

❌ Пытаться объяснить алгоритмы на словах
✅ Написать пример псевдокода

Особенно актуально, если автор не совсем понимает что от него хочет ревьюер. Не нужно полностью писать реализацию. Напишите небольшой пример псевдокода. Gitlab, github и bitbucket позволяют вставлять в комментарии разметку markdown. Ваш код будет хорошо отформатирован и более понятен, чем длинная цепочка комментов.

![](https://paper-attachments.dropbox.com/s_2F609ACD82D75F4A8DC0E50DFFEE216D00CD5915FEFA922E5E1FCCFDA5A0BE1A_1629225834194_++.jpeg)


❌ Оставлять больше 50 комментариев
✅ Оставлять до 50 комментариев

Если комментариев накапливается очень много, то у вас:

- Или не настроены линтеры, и вы не определились со стилем, поэтому комменты о вкусовщине
- Или переделать в коде нужно многое

Во втором случае оставьте 1 комментарий с рекомендациями как и что нужно переписать. В таком случае лучше закрыть мердж реквест, переписать код и открыть новый.

Если код будет переписан полностью, отследить изменение по комментариям практически невозможно и они не имеют смысла. Авторы тоже должны это понимать и следить, чтобы всем было комфортно.

❌ Отправлять огромные фрагменты кода на ревью
✅ Дробить большие участки кода на несколько реквестов и вливать постепенно

Задачи бывают разными по объему. Может быть задача исправить 1 строчку кода, а может быть задача отрефакторить весь проект. Во втором случае не отправляйте реквест в котором исправлены 500 файлов и 4000 изменений. Никто в здравом уме не сможет это нормально проверить, и желания такое проверять вы тоже не найдете.

Чтобы избежать:

- Сделайте ветку feature/epic-name
- Изменения делайте в ветке feature/epic-name-implement
- Pull реквесты делайте в ветку feature/epic-name. Порционно.
- В конце реализации фичи подлейте feature/epic-name в мастер. Да, в этом случае пулл реквест тоже будет огромный, но всё уже будет заранее проверено

Другой вариант как этого избежать: feature flags. Вы вливаете изменения на прод, но не даете им пользоваться. Нормально это реализовано мало у кого. Поэтому с этим подходом нужно быть осторожнее.

![](https://paper-attachments.dropbox.com/s_2F609ACD82D75F4A8DC0E50DFFEE216D00CD5915FEFA922E5E1FCCFDA5A0BE1A_1629308530693_++2021-08-18++20.41.58.png)

## В заключении

В этой статье я хотел рассказать и показать плюсы проведения код ревью. Будучи старшим разработчиком я всегда за то, чтобы мой код проходил code review. Лично для меня это отличный способ “увидеть” свой код чужими глазами. еще до того как ветка отправляется на ревью. Не говоря уже о том, что для команд это недорогой и эффективный способ иметь кодовую базу, с которой можно будет эффективно работать.

Если в вашей команде нет код ревью, то самое время его внедрить 🙂.

## Почитать

По теме рекомендую почитать:
[Статья How to Do Code Reviews Like a Human](https://mtlynch.io/human-code-reviews-1/)


## Благодарности

Спасибо лису и kirjs из [@learnInPublic](https://t.me/LearnInPublic) за ревью

